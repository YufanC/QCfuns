---
title: "QC workflow using QCfuns"
author: "Yufan Chen"
output: 
  rmarkdown::html_vignette:
    toc: yes
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{QC Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction
QCfuns package is a collection of R functions aiming to facilitate outputs validation
process. The functions can interact with each other and all together construct
a workflow that is efficient and easy to follow.

There are two types of functions in the workflow:

* Data to table functions. These functions take a dataframe of ADaM structure
as input and output a table-like dataframe. The names of these functions always
start with "qc_" and end with the type of table they are creating, 
such as qc_demo, qc_shift.

* Utility functions. Utility functions are functions that perform tasks
other than creating table-like dataframe from ADaM dataset. These functions
include addQCscript, qc_rtf2df, qc_compare2xlsx and qc_batchrun.

## Use QCfuns in QC workflow
```{r setup}
library(QCfuns)
```
### Add QC script template to code snippet
You can add QC script template to your code snippet by running the following code. 
Then follow the prompt in console to proceed
```{r eval=FALSE}
addQCscript()
```

Or you can do the same by clicking the `Add QC script` in Addins.
```{r out.width="80%", echo = FALSE}
knitr::include_graphics("addQCscript.png")
```

The QC script template looks like this:
```{r eval=FALSE}
# Original Reporting Effort:  Reporting effort
# Program Name             :  Program name
# R Version                :  R version 4.1.0 (2021-05-18)
# Short Description        :  Description
# Author                   :  Author
# Date                     :  2023-04-19
# input                    :
# Output                   :  
# Remarks                  :

# Modification History
#Rev       Modified By         Reporting Effort         Date      Description

#### Prepping environment     
library(haven)
library(dplyr)
library(tidyr)
library(stringr)
library(QCfuns)

files.sources <- list.files(path = read_path(rptdrv, "qc"), pattern = "^qcf.*\\.r", full.names = T)
sapply(files.sources, source)

#### Derive QC dataset 
adsl <- read_sas(read_path(a_in, "adsl.sas7bdat")) %>% 
  ### Convert empty strings into missing values using zap_empty function
  mutate(across(where(is.character), zap_empty))
  
#### Generate QC table 
first_row <- qc_cntrow1(adsl, "TRT01P", row_text = "Analysis set: Safety")

tab1 <- qc_cat_row(adsl, "TRT01P", rowvar = "SEX")

tab_qc <- bind_rows(first_row[[2]], tab1) %>% 
  mutate(across(everything(), ~replace(., is.na(.), "")))

#### Read in RTF
tableid <- "tableid"
tab_rtf <- qc_rtf2df(tableid)

#### Compare two datasets
qc_compare2xlsx(qc = tab_qc, rtf = tab_rtf, path = qc, filename = tableid)
```

### Construct data frame using data to table functions
All data to table functions are listed below. For detailed description and example, please go to each function's help page.

Function Name           | Description
:---------------------- | :-------------------------------------------------------
`qc_cntrow1`            | Create Analysis Set Row 
`qc_cntrow1_chg`        | Create Analysis Set Row for Change From Baseline Table
`qc_cntrow1_shift`      | Create Analysis Set Row for Shift Table
`qc_cat_row`            | Create Rows for Categorical Variables
`qc_num_row`            | Create Rows for Continuous Variables
`qc_demo`               | Create Demographic Rows
`qc_cntpct`             | Create Count and Percentage Row
`qc_cntpct_byrowvar`    | Create Count and Percentage Table by Row Variables
`qc_chgfb`              | Create Change From Baseline Over Time Table
`qc_shift`              | Create Shift Table

### Read in rtf and compare
### Batch run